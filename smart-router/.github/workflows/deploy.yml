name: Test and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: project-router-488807
  REGION: us-central1
  SERVICE: smart-router
  IMAGE: us-central1-docker.pkg.dev/project-router-488807/smart-router/smart-router

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: router_user
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: smart_router
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://router_user:testpassword@localhost:5432/smart_router
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        run: python -m app.database

      - name: Run tests
        run: pytest tests/ -v --tb=short

  deploy:
    name: Deploy to Cloud Run
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/1057539808346/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@project-router-488807.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and push image
        run: |
          docker build --platform linux/amd64 -t $IMAGE:${{ github.sha }} -t $IMAGE:latest .
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE \
            --image=$IMAGE:${{ github.sha }} \
            --region=$REGION \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=project-router-488807:us-central1:smart-router-db \
            --set-secrets="ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest,GROQ_API_KEY=GROQ_API_KEY:latest,DB_PASSWORD=DB_PASSWORD:latest" \
            --set-env-vars="POSTGRES_USER=router_user,POSTGRES_DB=smart_router,POSTGRES_HOST=/cloudsql/project-router-488807:us-central1:smart-router-db" \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=3

      - name: Verify deployment
        run: |
          URL=$(gcloud run services describe $SERVICE --region=$REGION --format='value(status.url)')
          curl -f $URL/v1/health